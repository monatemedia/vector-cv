name: Deploy Vector CV to Production

on:
  push:
    tags:
      - "v*" # Trigger on version tags (e.g., v1.0.0, v2.1.5)
  workflow_dispatch: # Allow manual triggers

env:
  REGISTRY: ghcr.io

jobs:
  build-and-publish:
    name: Build and Publish Docker Images
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image-tag: ${{ steps.set-tag.outputs.tag }}
      version-tag: ${{ steps.set-tag.outputs.version }}
      image-name: ${{ steps.set-image-name.outputs.image_name }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set image name to lowercase
        id: set-image-name
        run: |
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/vector-cv"
          IMAGE_NAME_LOWER=$(echo "$IMAGE_NAME" | tr '[:upper:]' '[:lower:]')
          echo "image_name=$IMAGE_NAME_LOWER" >> $GITHUB_OUTPUT
          echo "Using image name: $IMAGE_NAME_LOWER"

      - name: Determine image tag and version
        id: set-tag
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
            echo "tag=production" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üì¶ Building tagged release: v$VERSION"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
            echo "tag=dev" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "üîß Building development: $VERSION"
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Images
        run: |
          FULL_IMAGE_NAME="${{ steps.set-image-name.outputs.image_name }}"
          TAG="${{ steps.set-tag.outputs.tag }}"
          VERSION="${{ steps.set-tag.outputs.version }}"

          echo "üèóÔ∏è Building multi-stage Docker image..."

          # Build the image with all stages
          docker buildx build \
            --platform linux/amd64 \
            --file ./Dockerfile \
            --tag ${FULL_IMAGE_NAME}:${TAG} \
            --tag ${FULL_IMAGE_NAME}:v${VERSION} \
            --tag ${FULL_IMAGE_NAME}:${{ github.sha }} \
            --cache-from type=registry,ref=${FULL_IMAGE_NAME}:buildcache \
            --cache-to type=registry,ref=${FULL_IMAGE_NAME}:buildcache,mode=max \
            --push \
            .

          echo "‚úÖ Images built and pushed successfully"

      - name: Output deployment info
        run: |
          echo "üìå Version: ${{ steps.set-tag.outputs.version }}"
          echo "üè∑Ô∏è  Image Tags:"
          echo "   ‚Ä¢ ${{ steps.set-image-name.outputs.image_name }}:${{ steps.set-tag.outputs.tag }}"
          echo "   ‚Ä¢ ${{ steps.set-image-name.outputs.image_name }}:v${{ steps.set-tag.outputs.version }}"
          echo "   ‚Ä¢ ${{ steps.set-image-name.outputs.image_name }}:${{ github.sha }}"

  deploy-production:
    needs: build-and-publish
    name: Deploy to Production VPS
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    environment: "production"

    env:
      VERSION: ${{ needs.build-and-publish.outputs.version-tag }}
      IMAGE_NAME: ${{ needs.build-and-publish.outputs.image-name }}
      HOST: ${{ secrets.HOST }}
      USER: ${{ secrets.USER }}
      SSH_KEY: ${{ secrets.SSH_KEY }}
      WORK_DIR: ${{ secrets.WORK_DIR }}
      VIRTUAL_HOST: edward.monatemedia.com
      LETSENCRYPT_EMAIL: edward@monatemedia.com

    steps:
      - name: Checkout Code for Deployment Files
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          path: app-code

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ env.SSH_KEY }}

      - name: Add Production Server to Known Hosts
        run: |
          mkdir -p ~/.ssh
          echo "üîç Scanning host key for ${{ env.HOST }}..."

          for i in {1..3}; do
            if ssh-keyscan -T 10 -H ${{ env.HOST }} >> ~/.ssh/known_hosts; then
              echo "‚úÖ Successfully added host key on attempt $i."
              exit 0
            fi
            echo "‚ö†Ô∏è Attempt $i failed. Retrying in 5 seconds..."
            sleep 5
          done

          echo "üö® Error: ssh-keyscan failed after 3 attempts."
          exit 1

      - name: Ensure Proxy Network Exists
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            docker network create proxy-network 2>/dev/null || echo "‚úÖ proxy-network already exists"

      - name: Ensure Nginx Proxy Stack is Running
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            NGINX_PROXY_DIR="/home/${{ env.USER }}/nginx-proxy"
            echo "Checking Nginx Proxy stack in ${NGINX_PROXY_DIR}..."

            if [ -z "$(docker compose -f ${NGINX_PROXY_DIR}/docker-compose.yml ps -q)" ]; then
              echo "Starting Nginx Proxy stack..."
              docker compose -f ${NGINX_PROXY_DIR}/docker-compose.yml up -d
              echo "‚úÖ Nginx Proxy stack started."
            else
              echo "‚úÖ Nginx Proxy stack already running."
            fi

      - name: Create or Verify Work Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            if [ ! -d "${{ env.WORK_DIR }}" ]; then
              echo "üìÅ Creating work directory: ${{ env.WORK_DIR }}"
              mkdir -p ${{ env.WORK_DIR }}
            else
              echo "‚úÖ Work directory already exists: ${{ env.WORK_DIR }}"
            fi

            # Create necessary subdirectories
            mkdir -p ${{ env.WORK_DIR }}/storage
            mkdir -p ${{ env.WORK_DIR }}/generated_docs

            # Set ownership
            sudo chown -R ${{ env.USER }}:${{ env.USER }} ${{ env.WORK_DIR }}
            chmod 775 ${{ env.WORK_DIR }}

            echo "‚úÖ Work directory prepared"

      - name: Create Production .env File
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.HOST }}
          username: ${{ env.USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd ${{ env.WORK_DIR }}

            cat << 'EOF' > .env
            # Docker Configuration
            DOCKER_CONTAINER_NAME=vector-cv
            ENVIRONMENT=production
            IMAGE_NAME=${{ needs.build-and-publish.outputs.image-name }}
            IMAGE_TAG=production

            # Domain Configuration
            BASE_DOMAIN=edward.monatemedia.com
            VIRTUAL_HOST=edward.monatemedia.com
            LETSENCRYPT_EMAIL=edward@monatemedia.com

            # Port mappings for production VPS
            DOCKER_POSTGRES_PORT=5453
            DOCKER_BACKEND_PORT=8200
            DOCKER_ADMIN_PORT=8210
            DOCKER_FRONTEND_PORT=8220

            # Auth Credentials
            AUTH_USERNAME=${{ secrets.AUTH_USERNAME }}
            AUTH_PASSWORD=${{ secrets.AUTH_PASSWORD }}
            AUTH_NAME=${{ secrets.AUTH_NAME }}
            AUTH_EMAIL=${{ secrets.AUTH_EMAIL }}

            # Cookie settings
            COOKIE_NAME=vector_cv_auth
            COOKIE_KEY=${{ secrets.COOKIE_KEY }}

            # Database Components
            DB_USER=vector_cv_user
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            DB_HOST=postgres
            DB_PORT=5432
            DB_NAME=vector_cv_db

            # API Configuration
            PROXY_ROOT_PATH=${{ secrets.PROXY_ROOT_PATH }}

            # CORS Allowed Origins
            ALLOWED_ORIGINS=${{ secrets.ALLOWED_ORIGINS }}

            # Rate Limiting Settings
            ADMIN_API_KEY=${{ secrets.ADMIN_API_KEY }}
            ENABLE_RATE_LIMITING=true
            MAX_CV_PER_DAY=3
            GENERAL_RATE_LIMIT=60

            # OpenAI API
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            EOF

            echo "‚úÖ Production .env file created"

      - name: Transfer Deployment Files
        run: |
          scp -o StrictHostKeyChecking=no \
            ./app-code/docker-compose.yml \
            ./app-code/deploy-prod.sh \
            ${USER}@${HOST}:${WORK_DIR}/

          ssh ${USER}@${HOST} "chmod +x ${WORK_DIR}/deploy-prod.sh"

          echo "‚úÖ Deployment files transferred"

      - name: Execute Deployment Script
        run: |
          ssh ${{ env.USER }}@${{ env.HOST }} \
            'cd ${{ env.WORK_DIR }} && \
            export IMAGE_NAME="${{ needs.build-and-publish.outputs.image-name }}" && \
            export VIRTUAL_HOST="${{ env.VIRTUAL_HOST }}" && \
            ./deploy-prod.sh'

      - name: Wait for Services to Stabilize
        run: |
          echo "‚è≥ Waiting 20 seconds for services to stabilize..."
          sleep 20

      - name: External Health Check
        run: |
          APP_URL="https://${{ env.VIRTUAL_HOST }}"
          echo "üåê Performing external health check on ${APP_URL}..."

          MAX_RETRIES=5
          for i in $(seq 1 $MAX_RETRIES); do
            response=$(curl -s -L -o /dev/null -w "%{http_code}" ${APP_URL} || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Frontend health check passed (HTTP $response)"
              exit 0
            fi
            echo "‚ö†Ô∏è Attempt $i: Frontend returned $response. Retrying in 10s..."
            sleep 10
          done

          echo "‚ùå Frontend health check failed after $MAX_RETRIES attempts"
          # DEBUG: Show logs of the frontend if it fails
          ssh ${{ env.USER }}@${{ env.HOST }} "cd ${{ env.WORK_DIR }} && docker compose logs frontend --tail 20"
          exit 1

      - name: Cleanup SSH Keys
        if: always()
        run: rm -rf ~/.ssh

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ github.token }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          body: |
            ## Vector CV Deployment
            - **Version**: ${{ needs.build-and-publish.outputs.version-tag }}
            - **Environment**: Production
            - **Domain**: https://edward.monatemedia.com
            - **Deployed**: ${{ github.event.head_commit.timestamp }}
            - **Commit**: ${{ github.sha }}

            ### Services:
            - Frontend: https://edward.monatemedia.com
            - Admin: https://edward.monatemedia.com/admin
            - API Docs: https://edward.monatemedia.com/docs
          draft: false
          prerelease: false
